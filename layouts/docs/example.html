{{ define "main" }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.59.2/lib/codemirror.css" integrity="sha256-ylWkFzi+pmuVQm80SJjUJvNjzXmRc6+naSkH2xWL5+8=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.59.2/theme/monokai.css" integrity="sha256-JGPcb9kgGaDHyiqqAdAxFrKA+nxq4BvyHffBB9m2g+g=" crossorigin="anonymous">

{{ .Render "content" }}

<section>
    <p>
        <a id="play" class="btn btn-secondary"><i class="fas fa-play"></i> Run </a>
        <a id="download" class="btn btn-outline-secondary"><i class="fas fa-download"></i> Download </a>
    </p>

    <textarea id="code-mirror" rows="40">
    {{ path.Join .File.Dir .Params.source | readFile }}
    </textarea>
</section>

<script src="https://cdn.jsdelivr.net/npm/codemirror@5.59.2/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.59.2/mode/javascript/javascript.js" integrity="sha256-XxB90cNdnOuUFQjAE56w4OBTdMu5SHChSz02/Ki3oAQ=" crossorigin="anonymous"></script>
<script>
    var win;
    var el = document.getElementById('code-mirror');
    var cm = CodeMirror.fromTextArea(el,{
        theme:'monokai'
    });
    cm.setSize(null, 500);

    document.getElementById('download').addEventListener('click', function(){
        var filename = '{{ .Params.source }}';
		var blob = new Blob([cm.getValue()], { type: 'text/javascript' });

		if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveBlob(blob, filename);
		else {
			var elem = window.document.createElement('a');
			elem.href = window.URL.createObjectURL(blob);
			elem.download = filename;
			document.body.appendChild(elem);
			elem.click();
			document.body.removeChild(elem);
		}
    });

    document.getElementById('play').addEventListener('click', function(){
        var runminnoUrl = '{{ "runminno.html" | relURL }}';
        if (win) win.close();
        win = window.open(runminnoUrl, 'Playground');
        win.onload = function(){
            win.addEventListener('unload', function() {
                window.focus();
            });
            win.activate(cm.getValue());
        };
    });
</script>
{{ end }}
